<!DOCTYPE html>

<html>
	<head>
		<title>Dashboard</title>

		<script 
			src="https://www.unpkg.com/@propelauth/javascript@2.0.11/dist/javascript.min.js" 
			integrity="sha384-FENNH2f7QuQvkZJBL7jebLr0OtYKgTA2iq+C5g3VXXX7SBwWmeMMoc+pBBtcn76G" 
			crossorigin="anonymous"></script>
		<script src="/static/js/authuser.js"></script>

	</head>

	<body>
		<script>
			execWithUserData(async (userData, authInfo) => { // main function for page
				const greeting = document.createElement("h1")

				authInfo

				greeting.textContent = `Hello, ${authInfo.user.firstName}!`

				document.body.prepend(
					greeting
				)

				const journeysContainer = document.getElementById("myJourneys")

				const resp = await fetch("/api/listjourneys", {
					"headers": {
						Authorization: `Bearer ${authInfo.accessToken}`
					}
				});
				const recentJourneys = (await resp.json()).splice(-3)

				for (const journeyID of recentJourneys) // TODO: fix - doesn't work fro some reason
				{
					const journeyInfo = await (
						await fetch(`/api/getjourney?id=${journeyID}`, {
							"headers": {
								Authorization: `Bearer ${authInfo.accessToken}`
							}
						})
					).json();
				
					const journeyDiv = document.createElement("div");

					const journeyName = document.createElement("h1");

					journeyName.textContent = journeyInfo.name;

					journeyDiv.appendChild(
						journeyName
					)

					journeysContainer.appendChild(journeyDiv)
				}
			})
		</script>
	</body>

	<h2>Recent Journeys</h2>
	<div id="myJourneys">

	</div>
	<a href="/new-journey">Start a Journey</a>
</html>